	AREA text, CODE, READONLY
		EXPORT Kalmanfilter_asm		
Kalmanfilter_asm

		; SETTING KALMANFILTER STATE
		; THE BLOCK BELOW SHOULD BE REMOVED WHEN STATE VARIBLES ARE ALREADY IN MEMORY
		;VMOV.F32 S1, #10
		;VMOV.F32 S2, #1
		;VDIV.F32 S1, S2, S1
		;VMOV.F32 S2, S1
		;MOV R3,#0x20000000
		;VSTR S1, [R3]		; q
		;VSTR S2, [R3, #4]	; r
		;VSTR S3, [R3, #12]	; P
		;VMOV.F32 S1, #30
		;VMOV.F32 S2, #30
		;VMOV.F32 S3, #30
		
		; GET STATE VARIABLES FROM MEMORY
		VLDR S1, [R3]		; q
		VLDR S2, [R3, #4]	; r
		VLDR S5, [R3, #8]	; x
		VLDR S3, [R3, #12]	; P
		VLDR S4, [R3, #16]	; k
		
		
		
		; STORE SOME VALUES IN MEMORY
		; THE BLOCK BELOW SHOULD BE REMOVED WHEN DATA ARE ALREADY IN MEMORY
		;ADD R1, R3, #40
		;VMOV.F32 S6, #10
		;VMOV.F32 S7, #9
		;VSTR S6, [R1]
		;VSTR S7, [R1, #4]
		;MOV R2, #2
		;ADD R0, R1, #40
		
		
		; INITIALIZE COUNTER TO 1
		MOV R4, #1
		
		; MOVE R0 TO R5 TO KEEP R0 AND FOLLOW THE ARRAY USING R5
		MOV R5, R0
		
		; update
UPDATE	VLDR S0, [R1]	; CONTAINS THE FIRST INPUT
		VADD.F32 S3, S3, S1
		VADD.F32 S5, S3, S1 ;P+R
		VDIV.F32 S4, S3, S5
		VSUB.F32 S6, S0, S5
		VMUL.F32 S7, S4, S6
		VADD.F32 S5, S5, S7
		VNEG.F32 S8, S4
		VADD.F32 S8, S8, S4
		VMUL.F32 S3, S8, S3
		VSTR S5, [R5]	; WRITE THE INPUT IN MEMORY
		ADD R5, R5, #4	; INCREMENT OUTPUT POINTER
		ADD R1, R1, #4	; INCREMENT INPUT POINTER
		ADD R4, #1		; INCREMENT COUNTER
		CMP R4, R2		; COMPARE ARRAY LENGTH VS COUNTER
		BLE UPDATE		; ARRAY LENGTH IS HIGHER THAN THE COUNTER, LOOP AGAIN
		
		VLDM R0, {S10-S31}
		
	BX	LR;

	END